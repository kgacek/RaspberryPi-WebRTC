name: Build in Docker

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    paths-ignore:
      - 'doc/**'
      - 'example/**'
      - '.github/**'
      - '.vscode/**'
      - '*.md'
  workflow_dispatch:

jobs:
  prepare-env:
    runs-on: ubuntu-24.04-arm
    outputs:
      raspios_version: ${{ steps.os_version.outputs.name }}
    steps:
      - name: Extract OS Version
        id: os_version
        run: |
          FILE_URL=$(curl -sI https://downloads.raspberrypi.org/raspios_lite_arm64_latest | grep -i '^location:' | awk '{print $2}' | tr -d '\r')
          FILENAME=$(basename "$FILE_URL")
          # Extract raspios-XXX-arm64 pattern (e.g. raspios-bookworm-arm64)
          OS_NAME=$(echo "$FILENAME" | grep -oE 'raspios-[a-z]+-arm64' || echo "raspios-bookworm-arm64")
          echo "Detected OS version: $OS_NAME"
          echo "name=$OS_NAME" >> $GITHUB_OUTPUT

      - name: Download and Prepare Raspberry Pi OS Image
        run: |
          wget -q https://downloads.raspberrypi.org/raspios_lite_arm64_latest -O rpi-os.img.xz
          xz -d rpi-os.img.xz

          SECTOR_SIZE=512
          START_SECTOR=$(fdisk -l rpi-os.img | awk '/^rpi-os.img2/ { print $2 }')
          OFFSET=$((START_SECTOR * SECTOR_SIZE))
          OFFSET=$((START_SECTOR * SECTOR_SIZE))
          echo "Mounting with offset=$OFFSET"

          sudo mkdir boot
          sudo mount -o loop,offset=$OFFSET rpi-os.img boot
          sudo tar -C boot -cf rpi-rootfs.tar .
          docker import rpi-rootfs.tar rpi-docker-image
          sudo umount boot

      - name: Install dependencies
        run: |
          docker run --name rpi-container -v ${{ github.workspace }}:/app rpi-docker-image /usr/bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive &&
            export DEBCONF_NONINTERACTIVE_SEEN=true &&
            apt update --fix-missing &&
            apt install -y --no-install-recommends \
              wget \
              curl \
              cmake \
              clang \
              build-essential \
              mosquitto-dev \
              libboost-program-options-dev \
              libboost-system-dev \
              libboost-thread-dev \
              libavformat-dev \
              libavcodec-dev \
              libavutil-dev \
              libswscale-dev \
              libpulse-dev \
              libasound2-dev \
              libjpeg-dev \
              libcamera-dev \
              libmosquitto-dev \
              libcurl4-openssl-dev \
              protobuf-compiler \
              libprotobuf-dev || true &&
            cd /app &&
            wget -q https://github.com/TzuHuanTai/Native-WebRTC-Build/releases/download/5790/libwebrtc-arm64.tar.gz &&
            tar -xzf libwebrtc-arm64.tar.gz &&
            mkdir -p /usr/local/include/webrtc &&
            mv include/* /usr/local/include/webrtc &&
            mv lib/* /usr/local/lib &&
            mkdir -p /usr/local/include/nlohmann &&
            curl -L https://raw.githubusercontent.com/nlohmann/json/v3.11.3/single_include/nlohmann/json.hpp -o /usr/local/include/nlohmann/json.hpp
          "

      - name: Commit Docker Image
        run: |
          docker commit rpi-container rpi-docker-env
          docker rm rpi-container

      - name: Save Docker image
        run: docker save rpi-docker-env -o rpi-docker-env.tar

      - name: Cache Docker Image
        uses: actions/cache@v4
        with:
          path: rpi-docker-env.tar
          key: rpi-docker-env-${{ runner.os }}-${{ hashFiles('**/Dockerfile', '.github/workflows/**') }}
          restore-keys: |
            rpi-docker-env-${{ runner.os }}-

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push RaspiOS Dev Image
        run: |
          RASPIOS_VERSION="${{ needs.prepare-env.outputs.raspios_version }}"
          if [ -z "$RASPIOS_VERSION" ]; then
            echo "Warning: raspios_version is empty, using default"
            RASPIOS_VERSION="raspios-bookworm-arm64"
          fi
          
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/raspberrypi-webrtc-dev:${RASPIOS_VERSION}"
          IMAGE_LATEST="ghcr.io/${{ github.repository_owner }}/raspberrypi-webrtc-dev:latest"
          
          echo "Tagging images:"
          echo "  - $IMAGE_NAME"
          echo "  - $IMAGE_LATEST"
          
          docker tag rpi-docker-env "$IMAGE_NAME"
          docker tag rpi-docker-env "$IMAGE_LATEST"
          
          docker push "$IMAGE_NAME"
          docker push "$IMAGE_LATEST"
          
          echo "âœ… Published development image:"
          echo "   $IMAGE_NAME"
          echo "   $IMAGE_LATEST"
  
  build:
    runs-on: ubuntu-24.04-arm
    needs: prepare-env
    strategy:
      matrix:
        build_type: [Debug, Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore Docker Image from Cache
        uses: actions/cache@v4
        with:
          path: rpi-docker-env.tar
          key: rpi-docker-env-${{ runner.os }}-${{ hashFiles('**/Dockerfile', '.github/workflows/**') }}
          restore-keys: |
            rpi-docker-env-${{ runner.os }}-

      - name: Load Docker Image
        run: docker load -i rpi-docker-env.tar

      - name: Build inside Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/app rpi-docker-env /usr/bin/bash -c "
            cd /app &&
            mkdir -p build &&
            cd build &&
            cmake .. -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} &&
            make -j$(nproc)
          "

      - name: Zip binary
        id: zip-binary
        run: |
          cd build
          RASPIOS_VERSION="${{ needs.prepare-env.outputs.raspios_version }}"
          if [ -z "$RASPIOS_VERSION" ]; then
            RASPIOS_VERSION="raspios-bookworm-arm64"
          fi
          
          if [ "${{ matrix.build_type }}" == "Release" ]; then
            FILENAME="pi-webrtc-${{ github.ref_name }}_${RASPIOS_VERSION}.tar.gz"
          else
            FILENAME="pi-webrtc-${{ github.ref_name }}_${RASPIOS_VERSION}_debug.tar.gz"
          fi
          sudo tar -czvf $FILENAME pi-webrtc
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Upload to GitHub
        uses: softprops/action-gh-release@v2
        with:
          files: build/${{ steps.zip-binary.outputs.filename }}
